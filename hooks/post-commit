#!/bin/bash
# devlog post-commit hook
# Captures git commit events and sends them to devlogd

# Get devlog binary path - adjust if needed
DEVLOG="devlog"

# Check if devlog is available
if ! command -v "$DEVLOG" &> /dev/null; then
    # Try using absolute path if devlog is in the same dir as this repo
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    DEVLOG="$SCRIPT_DIR/../../bin/devlog"

    if ! command -v "$DEVLOG" &> /dev/null && [ ! -f "$DEVLOG" ]; then
        # Silently exit if devlog is not found
        exit 0
    fi
fi

# Capture commit information
REPO_PATH="$(git rev-parse --show-toplevel 2>/dev/null)"
BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null)"
COMMIT_HASH="$(git rev-parse HEAD 2>/dev/null)"
COMMIT_MESSAGE="$(git log -1 --pretty=%B 2>/dev/null)"
COMMIT_AUTHOR="$(git log -1 --pretty=%an 2>/dev/null)"

# Send to devlog in the background (don't block git)
"$DEVLOG" ingest git-commit \
    --repo="$REPO_PATH" \
    --branch="$BRANCH" \
    --hash="$COMMIT_HASH" \
    --message="$COMMIT_MESSAGE" \
    --author="$COMMIT_AUTHOR" \
    &> /dev/null &

exit 0
